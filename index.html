<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>State Losses Map</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.30.0/plotly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
      font-weight: normal;;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }
    #losses {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #title {
      text-align: center;
      margin: 0;
      font-weight: 700;
      font-size: 1.5em;
    }
    #toolbar {
      text-align: center;
    }
    
    #back-btn {
      background: linear-gradient(135deg, #7845FA, #6431E6);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-family: Merriweather, Georgia, serif;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(120, 69, 250, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    #back-btn:hover {
      background: linear-gradient(135deg, #6431E6, #3D1B91);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(120, 69, 250, 0.4);
    }
    
    #back-btn:active {
      transform: translateY(0px);
      box-shadow: 0 2px 10px rgba(120, 69, 250, 0.3);
    }
    #map-panel {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #losses-map {
      width: 100%;
      aspect-ratio: 16 / 9;
      min-height: 450px;
      border-radius: 12px;
      background: transparent;
    }
    #sr {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    
    #grid-container {
      display: none;
      width: 100%;
      min-height: 450px;
      border-radius: 12px;
      background: #fff;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }
    
    #grid-container.show {
      display: grid;
    }
    
    #left-column {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e6ed;
    }
    
    #right-column {
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    #state-map-zoom {
      width: 100%;
      height: 300px;
      background: transparent;
    }
    
    #state-info {
      flex: 1;
      padding: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-top: 1px solid #e0e6ed;
    }
    
    #state-info h3 {
      color: #2c3e50;
      margin-bottom: 12px;
    }
    
    #state-info p {
      color: #5a6c7d;
      line-height: 1.5;
    }
    
    #chart-container {
      flex: 1;
      position: relative;
      min-height: 300px;
    }
    
    #bar-chart {
      width: 100% !important;
      height: 100% !important;
    }
    
    @media (max-width: 768px) {
      #grid-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
        min-height: 600px;
      }
      
      #left-column {
        border-right: none;
        border-bottom: 1px solid #eee;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="losses" role="region">
      <h2 id="title">State Losses (2025–26)</h2>
      <div id="toolbar">
        <button id="back-btn" style="display:none">
          <span>←</span>
          <span>Back to Full Map</span>
        </button>
      </div>
      <div id="map-panel">
        <div id="losses-map" tabindex="0"></div>
      </div>
      
      <div id="grid-container">
        <div id="left-column">
          <div id="state-map-zoom"></div>
          <div id="state-info">
            <h3 id="grid-state-name"></h3>
            <p id="grid-state-loss"></p>
            <p>Projected decline results in $7 billion lost and over 60,000 less jobs.</p>
          </div>
        </div>
        <div id="right-column">
          <h4 style="margin-top: 0; color: #2c3e50; font-size: 1.1em;">Five Year Trend</h4>
          <div id="chart-container">
            <canvas id="bar-chart"></canvas>
          </div>
        </div>
      </div>
      
      <div id="sr" aria-live="polite"></div>
    </div>
  </div>

  <script>
    window.addEventListener('load', function() {
      if (typeof Plotly === 'undefined') {
        console.error('Plotly failed to load');
        return;
      }
      if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load');
        return;
      }
      
      initializeVisualization();
      console.log("email me for more info maricarmenmosso@gmail.com");
    });
    
    function initializeVisualization() {
      const fmt = n => n.toLocaleString('en-US');
      const states = ["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Puerto Rico","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virgin Islands","Virginia","Washington","West Virginia","Wisconsin","Wyoming"];
      const losses = [55032190,1594215,144881731,23189572,1013730821,63824864,122665118,17713793,90425294,243363729,166591360,19689594,11944755,379887657,157360595,42931992,37271876,49024539,41802089,12966497,163581648,619722041,229783788,77048991,13207935,169927376,4534580,18575460,10048901,31326132,148328341,12826367,988805385,144375994,8724437,200264505,37579710,42335765,339979784,2124676,44149974,31757306,8813368,58460749,388453912,46148639,9862807,509519,127438527,144935744,11841709,85455267,3409571];
      const codes = { "Alabama":"AL","Alaska":"AK","Arizona":"AZ","Arkansas":"AR","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","District of Columbia":"DC","Florida":"FL","Georgia":"GA","Hawaii":"HI","Idaho":"ID","Illinois":"IL","Indiana":"IN","Iowa":"IA","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Mississippi":"MS","Missouri":"MO","Montana":"MT","Nebraska":"NE","Nevada":"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Puerto Rico":"PR","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Vermont":"VT","Virgin Islands":"VI","Virginia":"VA","Washington":"WA","West Virginia":"WV","Wisconsin":"WI","Wyoming":"WY" };
      
      const stateData = {
        "AL": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [8157, 8138, 9022, 10071, 10600, 9010],
          dollars: [251162108, 262289222, 305294207, 348580779, 366881270, 311849079],
          jobs: [2364, 2190, 2259, 2373, 2497, 2123]
        },
        "AK": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [282, 301, 290, 297, 313, 266],
          dollars: [8446083, 9684211, 9758858, 10097955, 10628098, 9033883],
          jobs: [57, 62, 60, 59, 62, 53]
        },
        "AZ": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [21197, 25677, 30054, 27883, 29347, 24945],
          dollars: [539750814, 778147847, 986417044, 917699011, 965878209, 820996478],
          jobs: [6470, 8449, 9685, 8196, 8626, 7332]
        },
        "AR": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [5104, 4579, 5680, 5776, 6079, 5167],
          dollars: [98309405, 110177062, 146634110, 146885647, 154597143, 131407572],
          jobs: [864, 836, 947, 910, 957, 814]
        },
        "CA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [132758, 134043, 138393, 140858, 148253, 126015],
          dollars: [4833523347, 5439664890, 6002408439, 6421097836, 6758205472, 5744474652],
          jobs: [51378, 54023, 55167, 55114, 58007, 49306]
        },
        "CO": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [9569, 9355, 9920, 10363, 10907, 9271],
          dollars: [293418639, 322009837, 359198863, 404274670, 425499090, 361674227],
          jobs: [3513, 3456, 3617, 3846, 4048, 3441]
        },
        "CT": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [11778, 12352, 16727, 19990, 21039, 17884],
          dollars: [411648688, 496008357, 698205160, 776976201, 817767452, 695102334],
          jobs: [4524, 5038, 6228, 6650, 6999, 5949]
        },
        "DE": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [3339, 3046, 3819, 4023, 4234, 3599],
          dollars: [63974722, 86552859, 107737008, 112201384, 118091957, 100378163],
          jobs: [755, 916, 1039, 1017, 1070, 909]
        },
        "DC": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [10816, 10587, 11457, 11944, 12571, 10685],
          dollars: [390167872, 468001311, 525543651, 572765126, 602835295, 512410001],
          jobs: [3765, 4096, 4306, 4475, 4710, 4004]
        },
        "FL": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [39179, 39622, 42590, 44767, 47117, 40050],
          dollars: [1076213507, 1225709587, 1395540583, 1541496306, 1622424862, 1379061133],
          jobs: [11023, 11602, 12184, 12555, 13214, 11232]
        },
        "GA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [21515, 25057, 26450, 28175, 29654, 25206],
          dollars: [662086840, 834952110, 951663054, 1055210516, 1110609068, 944017708],
          jobs: [7139, 8276, 8842, 9348, 9839, 8363]
        },
        "HI": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [3227, 3422, 3939, 3675, 3868, 3288],
          dollars: [80321629, 103984574, 133579981, 124716354, 131263963, 111574368],
          jobs: [649, 751, 869, 782, 823, 699]
        },
        "ID": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [2952, 3230, 3263, 3349, 3525, 2996],
          dollars: [49594107, 63826118, 68357392, 75695572, 79631700, 67686945],
          jobs: [413, 455, 476, 528, 556, 472]
        },
        "IL": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [44004, 46599, 55337, 62299, 65570, 55734],
          dollars: [1260028715, 1615811503, 2057169693, 2406255941, 2532584378, 2152696721],
          jobs: [15657, 18163, 21158, 23055, 24266, 20626]
        },
        "IN": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [23948, 24628, 26739, 29536, 31087, 26424],
          dollars: [693876852, 785063540, 890188092, 996741694, 1049070633, 891710038],
          jobs: [7600, 7837, 8297, 8561, 9011, 7659]
        },
        "IA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [9493, 8246, 8261, 8515, 8962, 7618],
          dollars: [239522738, 240621737, 250759308, 271936606, 286213278, 243281286],
          jobs: [1935, 1827, 1758, 1858, 1956, 1662]
        },
        "KS": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [7738, 8272, 9353, 8685, 9141, 7770],
          dollars: [190696925, 214327701, 246469466, 236084727, 248479175, 211207299],
          jobs: [1663, 1661, 1764, 1577, 1660, 1411]
        },
        "KY": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [10523, 8891, 9765, 10050, 10578, 8991],
          dollars: [272664824, 252284575, 308922930, 310527560, 326830257, 277805718],
          jobs: [1893, 1716, 1854, 1821, 1917, 1629]
        },
        "LA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [6325, 6062, 6626, 6891, 7253, 6165],
          dollars: [197703434, 212557353, 246686816, 264779660, 278680592, 236878503],
          jobs: [2152, 2079, 2251, 2269, 2389, 2030]
        },
        "ME": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [1427, 1492, 1703, 2007, 2112, 1796],
          dollars: [49366475, 60962658, 69750452, 82131417, 86443316, 73476819],
          jobs: [385, 417, 441, 499, 525, 446]
        },
        "MD": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [18784, 19651, 22743, 24493, 25779, 21912],
          dollars: [608205470, 773456514, 929419259, 1036146625, 1090544323, 926962674],
          jobs: [7152, 8570, 9617, 10180, 10714, 9107]
        },
        "MA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [66273, 71026, 79751, 82306, 86627, 73633],
          dollars: [2481461233, 3052328442, 3619849771, 3925396937, 4131480276, 3511758235],
          jobs: [27649, 31420, 34930, 35849, 37732, 32072]
        },
        "MI": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [27454, 27657, 33501, 38123, 40124, 34106],
          dollars: [828719634, 965457224, 1257101987, 1455479256, 1531891917, 1302108129],
          jobs: [9183, 9699, 11335, 11951, 12578, 10692]
        },
        "MN": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [13095, 13503, 14321, 14975, 15761, 13397],
          dollars: [345273370, 392667964, 459465954, 488037945, 513659937, 436610947],
          jobs: [3199, 3128, 3366, 3430, 3610, 3069]
        },
        "MS": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [2526, 2733, 2960, 3135, 3300, 2805],
          dollars: [51091045, 62670460, 73530743, 83660713, 88052900, 74844965],
          jobs: [493, 545, 593, 635, 668, 568]
        },
        "MO": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [17234, 19167, 24260, 32647, 34361, 29207],
          dollars: [446993114, 621295654, 827915288, 1076341255, 1132849171, 962921795],
          jobs: [5279, 6416, 7589, 8837, 9301, 7906]
        },
        "MT": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [902, 1200, 1241, 885, 931, 792],
          dollars: [23723695, 36243595, 40594562, 28722594, 30230530, 25695951],
          jobs: [221, 312, 314, 199, 209, 178]
        },
        "NE": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [4415, 3984, 4097, 4149, 4367, 3712],
          dollars: [118993529, 111315949, 112107877, 117659290, 123836403, 105260942],
          jobs: [1097, 889, 812, 782, 823, 699]
        },
        "NV": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [2131, 1943, 2031, 2075, 2184, 1856],
          dollars: [50082566, 52743094, 60921844, 63650997, 66992674, 56943773],
          jobs: [503, 489, 522, 524, 551, 469]
        },
        "NH": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [2828, 2942, 3767, 4520, 4757, 4044],
          dollars: [91824461, 121188513, 161274619, 198423638, 208840879, 177514747],
          jobs: [1115, 1314, 1521, 1703, 1792, 1523]
        },
        "NJ": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [19039, 18946, 21985, 23225, 24444, 20778],
          dollars: [617102772, 700112703, 861918529, 939530266, 988855605, 840527264],
          jobs: [6913, 7161, 8200, 8527, 8975, 7628]
        },
        "NM": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [2311, 2369, 2633, 2784, 2930, 2491],
          dollars: [53257002, 59618806, 71721550, 81243813, 85509113, 72682746],
          jobs: [494, 497, 543, 577, 607, 516]
        },
        "NY": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [106894, 113666, 126782, 135813, 142943, 121502],
          dollars: [3796461212, 4875932783, 5781073620, 6263217010, 6592035903, 5603230518],
          jobs: [38986, 45482, 50430, 51719, 54435, 46270]
        },
        "NC": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [18587, 20278, 23488, 24468, 25753, 21890],
          dollars: [483958076, 653004879, 816129822, 914495608, 962506627, 818130633],
          jobs: [5678, 7023, 8215, 8692, 9148, 7776]
        },
        "ND": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [1750, 1869, 2102, 2342, 2465, 2095],
          dollars: [31866390, 38345773, 43792655, 55261673, 58162911, 49438474],
          jobs: [242, 263, 284, 340, 358, 304]
        },
        "OH": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [29979, 31146, 34204, 36884, 38820, 32997],
          dollars: [858409156, 1009756621, 1173990698, 1268500426, 1335096698, 1134832194],
          jobs: [9293, 9835, 10683, 10937, 11511, 9785]
        },
        "OK": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [6147, 6125, 7651, 7772, 8180, 6953],
          dollars: [154189333, 165888798, 218859002, 238034582, 250531398, 212951688],
          jobs: [1409, 1383, 1582, 1631, 1717, 1459]
        },
        "OR": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [8360, 7613, 7379, 7326, 7711, 6554],
          dollars: [255058721, 249635185, 260191431, 268160029, 282238431, 239902666],
          jobs: [2503, 2173, 2058, 2014, 2120, 1802]
        },
        "PA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [42477, 44370, 48593, 50514, 53166, 45191],
          dollars: [1490263611, 1712000349, 2047181588, 2153474483, 2266531893, 1926552109],
          jobs: [18750, 19635, 21956, 21989, 23143, 19672]
        },
        "RI": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [4181, 4401, 4786, 4982, 5244, 4457],
          dollars: [182893314, 232086676, 257647041, 279651458, 294333160, 250183186],
          jobs: [1753, 2135, 2252, 2376, 2500, 2125]
        },
        "SC": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [5352, 5907, 6173, 6576, 6921, 5883],
          dollars: [128305194, 159302339, 181562080, 201154751, 211715375, 179958069],
          jobs: [1217, 1345, 1455, 1532, 1613, 1371]
        },
        "SD": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [1518, 1670, 2018, 2348, 2471, 2101],
          dollars: [26711507, 33408670, 44710568, 55824977, 58755788, 49942420],
          jobs: [184, 205, 252, 305, 321, 273]
        },
        "TN": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [6867, 7270, 9206, 10041, 10568, 8983],
          dollars: [216886098, 260248020, 332742601, 370297697, 389738326, 331277577],
          jobs: [2568, 2799, 3190, 3383, 3560, 3026]
        },
        "TX": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [67428, 70223, 80757, 89546, 94247, 80110],
          dollars: [1472331685, 1764606015, 2213816117, 2460515674, 2589692747, 2201238835],
          jobs: [16458, 18391, 21568, 22112, 23273, 19782]
        },
        "UT": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [8533, 9233, 10019, 9799, 10313, 8766],
          dollars: [207490779, 251706415, 302552437, 292311252, 307657593, 261508954],
          jobs: [2191, 2380, 2692, 2302, 2423, 2059]
        },
        "VT": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [1228, 1292, 1334, 1281, 1348, 1146],
          dollars: [51936987, 60399978, 63256874, 62472254, 65752047, 55889240],
          jobs: [410, 389, 367, 348, 367, 312]
        },
        "VA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [17472, 17841, 19365, 21243, 22358, 19005],
          dollars: [527648933, 604467386, 702437522, 807211570, 849590177, 722151651],
          jobs: [6150, 6553, 7054, 7650, 8052, 6844]
        },
        "WA": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [21402, 21144, 23100, 23878, 25132, 21362],
          dollars: [681508742, 739150660, 830302801, 918041131, 966238290, 821302547],
          jobs: [6397, 6354, 6415, 6645, 6993, 5944]
        },
        "WV": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [2825, 2480, 2494, 2369, 2493, 2119],
          dollars: [73264921, 71756953, 77070934, 75006866, 78944726, 67103017],
          jobs: [659, 579, 564, 515, 542, 461]
        },
        "WI": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [11433, 11949, 13650, 15587, 16405, 13945],
          dollars: [337158759, 399360984, 486205420, 541284352, 569701780, 484246513],
          jobs: [3849, 4092, 4650, 4857, 5112, 4345]
        },
        "WY": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [772, 780, 805, 839, 883, 751],
          dollars: [14261583, 16440390, 18485753, 21596652, 22730476, 19320905],
          jobs: [114, 117, 122, 142, 149, 127]
        }
      };
      
      const mapRows = states.map((n,i)=>({name:n,code:codes[n],loss:losses[i]})).filter(r=>r.code!="PR"&&r.code!="VI");
      const colorScale = [[0,"#E5DAFF"],[0.1,"#C6B0FD"],[0.2,"#A786FB"],[0.35,"#8C62F8"],[0.5,"#7845FA"],[0.65,"#7A45FF"],[0.75,"#6E42DE"],[0.85,"#6431E6"],[0.95,"#3D1B91"],[1,"#311579"]];

      const traceFull = {
        type:"choropleth", locationmode:"USA-states",
        locations: mapRows.map(r=>r.code),
        z: mapRows.map(r=>r.loss),
        text: mapRows.map(r=>r.name),
        hovertemplate:"<b>%{text}</b><br>Losses = $%{z:,}<extra></extra>",
        colorscale: colorScale,
        zmin: Math.min(...mapRows.map(r=>r.loss)),
        zmax: Math.max(...mapRows.map(r=>r.loss)),
        marker:{line:{color:"#fff",width:1}},
        showscale:true,
        colorbar:{
          title:"Losses ($)",
          tickvals:[1000000,500000000,1000000000],
          ticktext:["$1M","$500M","$1B"],
          orientation:"h", x:0.5, xanchor:"center",
          y:1.05, yanchor:"bottom", len:0.6, thickness:12,
          outlinewidth:0, ticks:"outside", tickangle:0
        }
      };

      const layoutFull = { geo:{scope:"usa", projection:{type:"albers usa"}}, margin:{t:40,r:10,b:20,l:10}, dragmode:false };

      const config = { responsive:true, displayModeBar:false, displaylogo:false, scrollZoom:false, doubleClick:"reset" };
      const mapDiv = document.getElementById("losses-map");
      const stateMapZoom = document.getElementById("state-map-zoom");
      const backBtn = document.getElementById("back-btn");
      const gridContainer = document.getElementById("grid-container");
      const mapPanel = document.getElementById("map-panel");
      const gridStateNameEl = document.getElementById("grid-state-name");
      const gridStateLossEl = document.getElementById("grid-state-loss");
      const sr = document.getElementById("sr");
      
      let currentChart = null;

      function drawFull(){
        Plotly.react(mapDiv, [traceFull], layoutFull, config);
        backBtn.style.display="none";
        gridContainer.classList.remove("show");
        mapPanel.style.display = "flex";
        sr.textContent="Full map view";
        
        if(currentChart) {
          currentChart.destroy();
          currentChart = null;
        }
        
        if(location.hash) history.replaceState && history.replaceState(null,"", "#");
      }

      function drawState(code){
        const r = mapRows.find(r=>r.code===code); 
        if(!r) return;
        
        mapPanel.style.display = "none";
        gridContainer.classList.add("show");
        
        const layoutZoom = {
          geo:{scope:"usa", projection:{type:"albers usa"}, fitbounds:"locations"},
          margin:{t:10,r:10,b:10,l:10},
          dragmode:false
        };
        
        const traceZoom = Object.assign({}, traceFull, { 
          locations:[code], 
          z:[r.loss], 
          text:[r.name],
          hovertemplate:`<b>${r.name}</b><br>Losses = $${fmt(r.loss)}<extra></extra>`,
          showscale:false 
        });
        
        Plotly.react(stateMapZoom, [traceZoom], layoutZoom, config);
        
        gridStateNameEl.textContent = r.name;
        gridStateLossEl.textContent = `Projected Losses: $${fmt(r.loss)}`;
        
        createBarChart(code, r.name);
        
        backBtn.style.display = "inline-block";
        sr.textContent = `Showing ${r.name}`;
        if(location.hash !== `#${code}`) history.replaceState && history.replaceState(null,"", `#${code}`);
        
        setTimeout(() => {
          Plotly.Plots.resize(stateMapZoom);
        }, 100);
      }
      
      function createBarChart(stateCode, stateName) {
        const ctx = document.getElementById('bar-chart');
        
        if(currentChart) {
          currentChart.destroy();
        }
        
        const data = stateData[stateCode];
        if (!data) {
          console.error(`No data available for state: ${stateCode}`);
          return;
        }
        
        setTimeout(() => {
          currentChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.years,
              datasets: [{
                label: 'Intl Students',
                data: data.students,
                backgroundColor: 'rgba(46, 125, 50, 0.4)',
                borderColor: 'rgba(46, 125, 50, 1)',
                borderWidth: 3,
                fill: true,
                pointBackgroundColor: 'rgba(46, 125, 50, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                tension: 0.4,
                yAxisID: 'y1',
                order: 3
              }, {
                label: 'U.S. Dollars',
                data: data.dollars,
                backgroundColor: 'rgba(120, 69, 250, 0.6)',
                borderColor: 'rgba(120, 69, 250, 1)',
                borderWidth: 3,
                fill: true,
                pointBackgroundColor: 'rgba(120, 69, 250, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                tension: 0.4,
                yAxisID: 'y',
                order: 2
              }, {
                label: 'Jobs',
                data: data.jobs,
                backgroundColor: 'rgba(255, 87, 51, 0.3)',
                borderColor: 'rgba(255, 87, 51, 1)',
                borderWidth: 4,
                fill: true,
                pointBackgroundColor: 'rgba(255, 87, 51, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                tension: 0.4,
                yAxisID: 'y1',
                order: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    boxWidth: 12,
                    padding: 12,
                    font: {
                      family: 'Merriweather',
                      size: 10
                    },
                    usePointStyle: true
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0,0,0,0.8)',
                  titleFont: {
                    family: 'Merriweather',
                    size: 12
                  },
                  bodyFont: {
                    family: 'Merriweather',
                    size: 11
                  },
                  callbacks: {
                    title: function(context) {
                      return `${stateName} - ${context[0].label}`;
                    },
                    label: function(context) {
                      const label = context.dataset.label;
                      const value = context.parsed.y;
                      
                      if (label === 'U.S. Dollars') {
                        return `${label}: $${value.toLocaleString()}`;
                      } else if (label === 'Intl Students') {
                        return `${label}: ${value.toLocaleString()}`;
                      } else if (label === 'Jobs') {
                        return `${label}: ${value.toLocaleString()}`;
                      }
                      return `${label}: ${value}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    font: {
                      family: 'Merriweather',
                      size: 9
                    }
                  }
                },
                
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                    display: true,
                    text: 'U.S. Dollars',
                    font: {
                      family: 'Merriweather',
                      size: 10
                    }
                  },
                  grid: {
                    color: 'rgba(0,0,0,0.1)'
                  },
                  max: Math.max(...data.dollars) * 1.1,
                  ticks: {
                    maxTicksLimit: 6,
                    font: {
                      family: 'Merriweather',
                      size: 9
                    },
                    callback: function(value) {
                      if (value >= 1000000000) {
                        return '$' + (value / 1000000000).toFixed(1) + 'B';
                      } else if (value >= 1000000) {
                        return '$' + (value / 1000000).toFixed(0) + 'M';
                      }
                      return '$' + value.toLocaleString();
                    }
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Jobs and Intl Students',
                    font: {
                      family: 'Merriweather',
                      size: 10
                    }
                  },
                  grid: {
                    drawOnChartArea: false,
                  },
                  max: Math.max(Math.max(...data.students), Math.max(...data.jobs)) * 1.1,
                  ticks: {
                    maxTicksLimit: 6,
                    stepSize: function() {
                      const maxVal = Math.max(Math.max(...data.students), Math.max(...data.jobs));
                      return Math.ceil(maxVal / 5000) * 1000;
                    },
                    font: {
                      family: 'Merriweather',
                      size: 9
                    },
                    callback: function(value) {
                      if (value >= 1000) {
                        return (value / 1000).toFixed(1) + 'K';
                      }
                      return value.toLocaleString();
                    }
                  }
                }
              }
            }
          });
        }, 150);
      }

      Plotly.newPlot(mapDiv, [traceFull], layoutFull, config);
      mapDiv.on("plotly_click", ev => {
        if(ev.points && ev.points[0] && ev.points[0].location) {
          drawState(ev.points[0].location);
        }
      });
      backBtn.onclick = () => { drawFull(); mapDiv.focus(); };
      window.onhashchange = () => { 
        const hash = location.hash.replace("#","");
        if(hash) {
          drawState(hash);
        } else {
          drawFull();
        }
      };
      window.addEventListener("resize", () => {
        Plotly.Plots.resize(mapDiv);
        if(document.getElementById("grid-container").classList.contains("show")) {
          Plotly.Plots.resize(stateMapZoom);
        }
      });
      if(location.hash) drawState(location.hash.replace("#",""));
    }
  </script>
</body>
</html>
