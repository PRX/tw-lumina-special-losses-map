<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>State Losses Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.30.0/plotly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Merriweather, Georgia, serif;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }
    #losses {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #title {
      text-align: center;
      margin: 0;
      font-weight: 700;
      font-size: 1.5em;
    }
    #toolbar {
      text-align: center;
    }
    
    #back-btn {
      background: linear-gradient(135deg, #7845FA, #6431E6);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-family: Merriweather, Georgia, serif;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(120, 69, 250, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    #back-btn:hover {
      background: linear-gradient(135deg, #6431E6, #3D1B91);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(120, 69, 250, 0.4);
    }
    
    #back-btn:active {
      transform: translateY(0px);
      box-shadow: 0 2px 10px rgba(120, 69, 250, 0.3);
    }
    #map-panel {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #losses-map {
      width: 100%;
      aspect-ratio: 16 / 9;
      min-height: 450px;
      border-radius: 12px;
      background: transparent;
    }
    #details {
      display: none;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fff;
      padding: 12px;
      box-sizing: border-box;
      width: 100%;
      max-width: 700px;
      margin: 12px auto 0;
    }
    #details.show {
      display: block;
    }
    #details h3 {
      margin: 0 0 8px;
      font-size: 1.25em;
    }
    #details p {
      margin: 4px 0;
    }
    #sr {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    
    #grid-container {
      display: none;
      width: 100%;
      min-height: 450px;
      border-radius: 12px;
      background: #fff;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }
    
    #grid-container.show {
      display: grid;
    }
    
    #left-column {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e0e6ed;
    }
    
    #right-column {
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    #state-map-zoom {
      width: 100%;
      height: 300px;
      background: transparent;
    }
    
    #state-info {
      flex: 1;
      padding: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-top: 1px solid #e0e6ed;
    }
    
    #state-info h3 {
      color: #2c3e50;
      margin-bottom: 12px;
    }
    
    #state-info p {
      color: #5a6c7d;
      line-height: 1.5;
    }
    
    #chart-container {
      flex: 1;
      position: relative;
      min-height: 300px;
    }
    
    #bar-chart {
      width: 100% !important;
      height: 100% !important;
    }
    
    @media (max-width: 768px) {
      #grid-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
        min-height: 600px;
      }
      
      #left-column {
        border-right: none;
        border-bottom: 1px solid #eee;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="losses" role="region">
      <h2 id="title">State Losses (2025–26)</h2>
      <div id="toolbar">
        <button id="back-btn" style="display:none">
          <span>←</span>
          <span>Back to Full Map</span>
        </button>
      </div>
      <div id="map-panel">
        <div id="losses-map" tabindex="0"></div>
        <div id="details">
          <h3 id="state-name"></h3>
          <p id="state-loss"></p>
          <p>Other data: OTW</p>
        </div>
      </div>
      
      <div id="grid-container">
        <div id="left-column">
          <div id="state-map-zoom"></div>
          <div id="state-info">
            <h3 id="grid-state-name"></h3>
            <p id="grid-state-loss"></p>
            <p>Projected decline results in $7 billion lost and over 60,000 less jobs.</p>
          </div>
        </div>
        <div id="right-column">
          <h4 style="margin-top: 0; color: #2c3e50; font-size: 1.1em;">Five Year Trend</h4>
          <div id="chart-container">
            <canvas id="bar-chart"></canvas>
          </div>
        </div>
      </div>
      
      <div id="sr" aria-live="polite"></div>
    </div>
  </div>

  <script>

    window.addEventListener('load', function() {
      if (typeof Plotly === 'undefined') {
        console.error('Plotly failed to load');
        return;
      }
      if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load');
        return;
      }
      
      initializeVisualization();
    });
    
    function initializeVisualization() {
      const fmt = n => n.toLocaleString('en-US');
      const states = ["Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Puerto Rico","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virgin Islands","Virginia","Washington","West Virginia","Wisconsin","Wyoming"];
      const losses = [55032190,1594215,144881731,23189572,1013730821,63824864,122665118,17713793,90425294,243363729,166591360,19689594,11944755,379887657,157360595,42931992,37271876,49024539,41802089,12966497,163581648,619722041,229783788,77048991,13207935,169927376,4534580,18575460,10048901,31326132,148328341,12826367,988805385,144375994,8724437,200264505,37579710,42335765,339979784,2124676,44149974,31757306,8813368,58460749,388453912,46148639,9862807,509519,127438527,144935744,11841709,85455267,3409571];
      const codes = { "Alabama":"AL","Alaska":"AK","Arizona":"AZ","Arkansas":"AR","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","District of Columbia":"DC","Florida":"FL","Georgia":"GA","Hawaii":"HI","Idaho":"ID","Illinois":"IL","Indiana":"IN","Iowa":"IA","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Mississippi":"MS","Missouri":"MO","Montana":"MT","Nebraska":"NE","Nevada":"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Puerto Rico":"PR","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Vermont":"VT","Virgin Islands":"VI","Virginia":"VA","Washington":"WA","West Virginia":"WV","Wisconsin":"WI","Wyoming":"WY" };
      
      const stateData = {
        "AL": {
          years: ["2020-21", "2021-22", "2022-23", "2023-24", "2024-25", "2025-26"],
          students: [8157, 8138, 9022, 10071, 10600, 9010],
          dollars: [251162108, 262289222, 305294207, 348580779, 366881270, 311849079],
          jobs: [2364, 2190, 2259, 2373, 2497, 2123]
        }

      };
      
      const mapRows = states.map((n,i)=>({name:n,code:codes[n],loss:losses[i]})).filter(r=>r.code!="PR"&&r.code!="VI");
      const colorScale = [[0,"#E5DAFF"],[0.1,"#C6B0FD"],[0.2,"#A786FB"],[0.35,"#8C62F8"],[0.5,"#7845FA"],[0.65,"#7A45FF"],[0.75,"#6E42DE"],[0.85,"#6431E6"],[0.95,"#3D1B91"],[1,"#311579"]];

      const traceFull = {
        type:"choropleth", locationmode:"USA-states",
        locations: mapRows.map(r=>r.code),
        z: mapRows.map(r=>r.loss),
        text: mapRows.map(r=>r.name),
        hovertemplate:"<b>%{text}</b><br>Losses = $%{z:,}<extra></extra>",
        colorscale: colorScale,
        zmin: Math.min(...mapRows.map(r=>r.loss)),
        zmax: Math.max(...mapRows.map(r=>r.loss)),
        marker:{line:{color:"#fff",width:1}},
        showscale:true,
        colorbar:{
          title:"Losses ($)",
          tickvals:[1000000,500000000,1000000000],
          ticktext:["$1M","$500M","$1B"],
          orientation:"h", x:0.5, xanchor:"center",
          y:1.05, yanchor:"bottom", len:0.6, thickness:12,
          outlinewidth:0, ticks:"outside", tickangle:0
        }
      };

      const layoutFull = { geo:{scope:"usa", projection:{type:"albers usa"}}, margin:{t:40,r:10,b:20,l:10}, dragmode:false };

      const config = { responsive:true, displayModeBar:false, displaylogo:false, scrollZoom:false, doubleClick:"reset" };
      const mapDiv = document.getElementById("losses-map");
      const stateMapZoom = document.getElementById("state-map-zoom");
      const backBtn = document.getElementById("back-btn");
      const details = document.getElementById("details");
      const gridContainer = document.getElementById("grid-container");
      const mapPanel = document.getElementById("map-panel");
      const stateNameEl = document.getElementById("state-name");
      const stateLossEl = document.getElementById("state-loss");
      const gridStateNameEl = document.getElementById("grid-state-name");
      const gridStateLossEl = document.getElementById("grid-state-loss");
      const sr = document.getElementById("sr");
      
      let currentChart = null;

      function drawFull(){
        Plotly.react(mapDiv, [traceFull], layoutFull, config);
        backBtn.style.display="none";
        details.classList.remove("show");
        gridContainer.classList.remove("show");
        mapPanel.style.display = "flex";
        stateNameEl.textContent="";
        stateLossEl.textContent="";
        sr.textContent="Full map view";
        
        if(currentChart) {
          currentChart.destroy();
          currentChart = null;
        }
        
        if(location.hash) history.replaceState && history.replaceState(null,"", "#");
      }

      function drawState(code){
        const r = mapRows.find(r=>r.code===code); 
        if(!r) return;
        
        mapPanel.style.display = "none";
        gridContainer.classList.add("show");
        
        const layoutZoom = {
          geo:{scope:"usa", projection:{type:"albers usa"}, fitbounds:"locations"},
          margin:{t:10,r:10,b:10,l:10},
          dragmode:false
        };
        
        const traceZoom = Object.assign({}, traceFull, { 
          locations:[code], 
          z:[r.loss], 
          text:[r.name],
          hovertemplate:`<b>${r.name}</b><br>Losses = $${fmt(r.loss)}<extra></extra>`,
          showscale:false 
        });
        
        Plotly.react(stateMapZoom, [traceZoom], layoutZoom, config);
        
        gridStateNameEl.textContent = r.name;
        gridStateLossEl.textContent = `Projected Losses: $${fmt(r.loss)}`;
        
        createBarChart(code, r.name);
        
        backBtn.style.display = "inline-block";
        sr.textContent = `Showing ${r.name}`;
        if(location.hash !== `#${code}`) history.replaceState && history.replaceState(null,"", `#${code}`);
        
        setTimeout(() => {
          Plotly.Plots.resize(stateMapZoom);
        }, 100);
      }
      
      function createBarChart(stateCode, stateName) {
        const ctx = document.getElementById('bar-chart');
        
        if(currentChart) {
          currentChart.destroy();
        }
        
        const data = stateData[stateCode] || stateData["AL"];
        const isUsingFallback = !stateData[stateCode] && stateCode !== "AL";
        
        currentChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.years,
            datasets: [{
              label: 'Intl Students',
              data: data.students,
              backgroundColor: 'rgba(46, 125, 50, 0.4)',
              borderColor: 'rgba(46, 125, 50, 1)',
              borderWidth: 3,
              fill: true,
              pointBackgroundColor: 'rgba(46, 125, 50, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              tension: 0.4,
              yAxisID: 'y1',
              order: 3
            }, {
              label: 'U.S. Dollars',
              data: data.dollars,
              backgroundColor: 'rgba(120, 69, 250, 0.6)',
              borderColor: 'rgba(120, 69, 250, 1)',
              borderWidth: 3,
              fill: true,
              pointBackgroundColor: 'rgba(120, 69, 250, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              tension: 0.4,
              yAxisID: 'y',
              order: 2
            }, {
              label: 'Jobs',
              data: data.jobs,
              backgroundColor: 'rgba(255, 87, 51, 0.3)',
              borderColor: 'rgba(255, 87, 51, 1)',
              borderWidth: 4,
              fill: true,
              pointBackgroundColor: 'rgba(255, 87, 51, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              tension: 0.4,
              yAxisID: 'y1',
              order: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              title: {
                display: isUsingFallback,
                text: `Using Alabama data (${stateName} data not available)`,
                font: {
                  size: 11,
                  style: 'italic'
                },
                color: '#666'
              },
              legend: {
                position: 'top',
                labels: {
                  boxWidth: 12,
                  padding: 12,
                  font: {
                    family: 'Merriweather',
                    size: 10
                  },
                  usePointStyle: true
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: {
                  family: 'Merriweather',
                  size: 12
                },
                bodyFont: {
                  family: 'Merriweather',
                  size: 11
                },
                callbacks: {
                  title: function(context) {
                    return `${stateName} - ${context[0].label}`;
                  },
                  label: function(context) {
                    const label = context.dataset.label;
                    const value = context.parsed.y;
                    
                    if (label === 'U.S. Dollars') {
                      return `${label}: $${value.toLocaleString()}`;
                    } else if (label === 'Intl Students') {
                      return `${label}: ${value.toLocaleString()}`;
                    } else if (label === 'Jobs') {
                      return `${label}: ${value.toLocaleString()}`;
                    }
                    return `${label}: ${value}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    family: 'Merriweather',
                    size: 9
                  }
                }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'U.S. Dollars',
                  font: {
                    family: 'Merriweather',
                    size: 10
                  }
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                },
                max: 380000000,
                ticks: {
                  font: {
                    family: 'Merriweather',
                    size: 9
                  },
                  callback: function(value) {
                    if (value >= 1000000000) {
                      return '$' + (value / 1000000000).toFixed(1) + 'B';
                    } else if (value >= 1000000) {
                      return '$' + (value / 1000000).toFixed(0) + 'M';
                    }
                    return '$' + value.toLocaleString();
                  }
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Jobs and Intl Students',
                  font: {
                    family: 'Merriweather',
                    size: 10
                  }
                },
                grid: {
                  drawOnChartArea: false,
                },
                max: 12000,
                ticks: {
                  font: {
                    family: 'Merriweather',
                    size: 9
                  },
                  callback: function(value) {
                    if (value >= 1000) {
                      return (value / 1000).toFixed(1) + 'K';
                    }
                    return value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }

      Plotly.newPlot(mapDiv, [traceFull], layoutFull, config);
      mapDiv.on("plotly_click", ev => {
        if(ev.points && ev.points[0] && ev.points[0].location) {
          drawState(ev.points[0].location);
        }
      });
      backBtn.onclick = () => { drawFull(); mapDiv.focus(); };
      window.onhashchange = () => { 
        const hash = location.hash.replace("#","");
        if(hash) {
          drawState(hash);
        } else {
          drawFull();
        }
      };
      window.addEventListener("resize", () => {
        Plotly.Plots.resize(mapDiv);
        if(document.getElementById("grid-container").classList.contains("show")) {
          Plotly.Plots.resize(stateMapZoom);
        }
      });
      if(location.hash) drawState(location.hash.replace("#",""));
    }
  </script>
</body>
</html>
