<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>State Losses (2025–26)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: Georgia, serif; background: transparent; color: #111; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h2 { margin: 12px 0 8px; text-align: center; font-weight: 700; font-size: clamp(20px, 4vw, 36px); }
    .toolbar { display: flex; justify-content: center; gap: 10px; margin: 8px 0 14px; }
    .btn { appearance: none; border: 1px solid #ddd; background: #fff; color: #111; padding: 10px 16px; border-radius: 999px; cursor: pointer; font-size: clamp(14px, 1.9vw, 16px); }
    .btn:hover { background: #f4f3ff; }
    .btn[hidden] { display: none; }
    #map { width: 100%; aspect-ratio: 16 / 10; min-height: clamp(320px, 58vw, 720px); background: transparent; }
    .info { margin: 10px auto 0; text-align: center; font-size: clamp(13px, 1.8vw, 15px); color: #333; min-height: 1.4em; }
    .sr { position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <div class="wrap" role="region" aria-label="Interactive map of projected state losses">
    <h2>State Losses (2025–26)</h2>
    <div class="toolbar">
      <button id="back" class="btn" hidden>← Back to full map</button>
    </div>
    <div id="map" aria-label="US choropleth map" tabindex="0"></div>
    <div id="info" class="info" aria-live="polite"></div>
    <div id="sr" class="sr" aria-live="polite"></div>
  </div>

  <script>
    (function () {
      const CDN = "https://cdn.plot.ly/plotly-2.30.0.min.js";
      const load = cb => window.Plotly ? cb() : (s => { s.src = CDN; s.onload = cb; document.head.appendChild(s) })(document.createElement("script"));
      load(init);

      function init() {
        const fmt0 = n => n.toLocaleString("en-US");

        const STATES = [
          ["AL","Alabama"],["AK","Alaska"],["AZ","Arizona"],["AR","Arkansas"],["CA","California"],["CO","Colorado"],
          ["CT","Connecticut"],["DE","Delaware"],["DC","District of Columbia"],["FL","Florida"],["GA","Georgia"],
          ["HI","Hawaii"],["ID","Idaho"],["IL","Illinois"],["IN","Indiana"],["IA","Iowa"],["KS","Kansas"],
          ["KY","Kentucky"],["LA","Louisiana"],["ME","Maine"],["MD","Maryland"],["MA","Massachusetts"],["MI","Michigan"],
          ["MN","Minnesota"],["MS","Mississippi"],["MO","Missouri"],["MT","Montana"],["NE","Nebraska"],["NV","Nevada"],
          ["NH","New Hampshire"],["NJ","New Jersey"],["NM","New Mexico"],["NY","New York"],["NC","North Carolina"],
          ["ND","North Dakota"],["OH","Ohio"],["OK","Oklahoma"],["OR","Oregon"],["PA","Pennsylvania"],["PR","Puerto Rico"],
          ["RI","Rhode Island"],["SC","South Carolina"],["SD","South Dakota"],["TN","Tennessee"],["TX","Texas"],
          ["UT","Utah"],["VT","Vermont"],["VI","Virgin Islands"],["VA","Virginia"],["WA","Washington"],
          ["WV","West Virginia"],["WI","Wisconsin"],["WY","Wyoming"]
        ];

        const LOSSES = [
          55032190,1594215,144881731,23189572,1013730821,63824864,122665118,17713793,90425294,243363729,
          166591360,19689594,11944755,379887657,157360595,42931992,37271876,49024539,41802089,12966497,
          163581648,619722041,229783788,77048991,13207935,169927376,4534580,18575460,10048901,31326132,
          148328341,12826367,988805385,144375994,8724437,200264505,37579710,42335765,339979784,2124676,
          44149974,31757306,8813368,58460749,388453912,46148639,9862807,509519,127438527,144935744,
          11841709,85455267,3409571
        ];

        const UNSUPPORTED = new Set(["PR", "VI"]);
        const rows = STATES.map((s, i) => ({ code: s[0], name: s[1], loss: LOSSES[i] }));
        const mapRows = rows.filter(r => !UNSUPPORTED.has(r.code));

        const LO = 1_000_000;
        const MID = 500_000_000;
        const HI = 1_000_000_000;

        const mapEl = document.getElementById("map");
        const backBtn = document.getElementById("back");
        const infoEl = document.getElementById("info");
        const srEl = document.getElementById("sr");

        const colors = [
          [0.00,"#f1d4ff"],[0.10,"#d08bff"],[0.20,"#b347ff"],[0.35,"#9826ff"],
          [0.50,"#7f00ff"],[0.65,"#6a00e6"],[0.75,"#5500cc"],[0.85,"#400099"],
          [0.95,"#2b0066"],[1.00,"#1a0044"]
        ];

        const baseLayout = {
          geo: { scope: "usa", projection: { type: "albers usa", scale: 0.85 }, bgcolor: "rgba(0,0,0,0)" },
          margin: { t: 26, r: 8, b: 8, l: 8 },
          dragmode: false,
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          hoverlabel: { bgcolor: "#222", bordercolor: "#222", font: { color: "#fff" } }
        };

        const cfg = {
          responsive: true,
          displaylogo: false,
          displayModeBar: "hover",
          modeBarButtonsToRemove: [
            "zoom2d","select2d","lasso2d","autoScale2d","zoomIn2d","zoomOut2d",
            "resetScale2d","pan2d","toImage","toggleSpikelines"
          ]
        };

        function getTickVals() {
          return window.innerWidth < 600 ? [HI] : [LO, MID, HI];
        }

        function getTickText() {
          return window.innerWidth < 600 ? [`$${fmt0(HI)}`] : [`$${fmt0(LO)}`, `$${fmt0(MID)}`, `$${fmt0(HI)}`];
        }

        function buildFullTrace() {
          return {
            type: "choropleth",
            locationmode: "USA-states",
            locations: mapRows.map(r => r.code),
            z: mapRows.map(r => r.loss),
            text: mapRows.map(r => r.name),
            customdata: mapRows.map(r => r.loss),
            hovertemplate: "<b>%{text}</b><br>Losses = $%{customdata:,.0f}<extra></extra>",
            colorscale: colors,
            zmin: LO,
            zmax: HI,
            showscale: true,
            colorbar: {
              title: "Losses ($)",
              orientation: "h",
              x: 0.5, xanchor: "center",
              y: 1.02, yanchor: "bottom",
              len: 0.58,
              thickness: 12,
              outlinewidth: 0,
              tickvals: getTickVals(),
              ticktext: getTickText()
            },
            marker: { line: { color: "#ffffff", width: 1 } },
            name: ""
          };
        }

        function drawFull() {
          Plotly.react(mapEl, [buildFullTrace()], baseLayout, cfg);
          backBtn.hidden = true;
          infoEl.textContent = "";
          srEl.textContent = "Showing full U.S. map.";
        }

        function drawState(code) {
          const row = rows.find(r => r.code === code);
          if (!row) return;
          const zoomTrace = {
            ...buildFullTrace(),
            locations: [code],
            z: [row.loss],
            text: [row.name],
            customdata: [row.loss],
            showscale: false
          };
          const layout = { ...baseLayout, geo: { scope: "usa", projection: { type: "albers usa" }, fitbounds: "locations" } };
          Plotly.react(mapEl, [zoomTrace], layout, cfg);
          infoEl.textContent = `${row.name} — $${fmt0(row.loss)}`;
          backBtn.hidden = false;
        }

        Plotly.newPlot(mapEl, [buildFullTrace()], baseLayout, cfg);

        mapEl.on("plotly_click", ev => {
          const code = ev.points?.[0]?.location;
          if (code) drawState(code);
        });

        backBtn.addEventListener("click", () => drawFull());
        window.addEventListener("resize", () => drawFull());
      }
    })();
  </script>
</body>
</html>
